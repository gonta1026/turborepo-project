name: Reusable Full Stack Tests
on:
  workflow_call:
    inputs:
      test-db-password:
        required: false
        type: string
        description: "Database password for tests"
    secrets:
      turbo-token:
        required: true
        description: "Turborepo remote cache authentication token"

jobs:
  # ===== Turboビルド（モノレポ全体） =====
  # Turborepoリモートキャッシュを使用したモノレポ全体のビルド・リント
  turbo-build:
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      api-test-needed: ${{ steps.test-changes.outputs.api-test-needed }}
      dashboard-test-needed: ${{ steps.test-changes.outputs.dashboard-test-needed }}
    steps:
      - uses: actions/checkout@v4

      # Node.js環境セットアップ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.10.0"

      # NPM依存関係のクリーンインストール
      - name: Install Dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install

      # 変更検知: テスト実行対象の決定
      - name: Detect Changes for Testing
        id: test-changes
        run: |
          echo "🔍 Checking which packages need testing..."
          
          # APIテストが必要かチェック
          if npx turbo-ignore api; then
            echo "api-test-needed=false" >> $GITHUB_OUTPUT
            echo "✅ API unchanged - skipping tests"
          else
            echo "api-test-needed=true" >> $GITHUB_OUTPUT
            echo "🔄 API changes detected - running tests"
          fi
          
          # Dashboardテストが必要かチェック
          if npx turbo-ignore dashboard; then
            echo "dashboard-test-needed=false" >> $GITHUB_OUTPUT
            echo "✅ Dashboard unchanged - skipping tests"
          else
            echo "dashboard-test-needed=true" >> $GITHUB_OUTPUT
            echo "🔄 Dashboard changes detected - running tests"
          fi

      # 選択的ビルド・リント実行
      - name: Build and Lint Changed Packages
        run: |
          echo "🔍 Debugging Turbo Remote Cache Configuration"
          echo "TURBO_API: $TURBO_API"
          echo "TURBO_TOKEN length: ${#TURBO_TOKEN}"
          echo "Testing server connection..."
          curl -s -w "HTTP Status: %{http_code}\n" "$TURBO_API/v8/artifacts/events?team=$TURBO_TEAM" -H "Authorization: Bearer $TURBO_TOKEN" | head -10 || echo "❌ Server connection failed"
          
          # 変更されたパッケージごとに個別にビルド・リント実行
          if [ "${{ steps.test-changes.outputs.api-test-needed }}" == "true" ]; then
            echo "🚀 Running build and lint for API..."
            npx turbo run build lint --filter=api --verbosity=2
          fi
          
          if [ "${{ steps.test-changes.outputs.dashboard-test-needed }}" == "true" ]; then
            echo "🚀 Running build and lint for Dashboard..."
            npx turbo run build lint --filter=dashboard --verbosity=2
          fi
          
          # 両方ともfalseの場合
          if [ "${{ steps.test-changes.outputs.api-test-needed }}" == "false" ] && [ "${{ steps.test-changes.outputs.dashboard-test-needed }}" == "false" ]; then
            echo "✅ No packages need building - all up to date"
          fi
        env:
          TURBO_API: https://turbo-cache-server-cvezib2f4q-an.a.run.app
          TURBO_TOKEN: ${{ secrets.turbo-token }}
          TURBO_TEAM: my-team
  # API テスト（変更検知時のみ実行）
  test-api:
    needs: turbo-build # Turboビルド完了後に実行
    if: needs.turbo-build.outputs.api-test-needed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: apps/api/go.mod
          cache: false

      - name: Install golang-migrate
        run: |
          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.0/migrate.linux-amd64.tar.gz | tar xvz
          sudo mv migrate /usr/local/bin/migrate
          migrate -version

      - name: PostgreSQL Test Container
        run: |
          docker run -d --name postgres-test \
            -p 5432:5432 \
            -e POSTGRES_USER=apiuser \
            -e POSTGRES_PASSWORD=${{ inputs.test-db-password }} \
            -e POSTGRES_DB=apidb \
            postgres:17-alpine
            
          # Wait for PostgreSQL
          until docker exec postgres-test pg_isready -U apiuser; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Run Database Migrations
        run: |
          cd apps/api
          migrate -path migrations -database "postgres://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME?sslmode=disable" up
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_USER: apiuser
          DB_PASSWORD: ${{ inputs.test-db-password }}
          DB_NAME: apidb

      - name: Run API Tests
        run: |
          cd apps/api
          go test -v ./...
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_USER: apiuser
          DB_PASSWORD: ${{ inputs.test-db-password }}
          DB_NAME: apidb

  # Dashboard テスト（変更検知時のみ実行）
  test-dashboard:
    needs: turbo-build # Turboビルド完了後に実行
    if: needs.turbo-build.outputs.dashboard-test-needed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.10.0"

      # 依存関係のインストール（ビルドは turbo-build で完了済み）
      - name: Install Dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install

      # Dashboardコンポーネントテスト実行
      - name: Run Dashboard Tests
        run: |
          npm run test --workspace=dashboard
