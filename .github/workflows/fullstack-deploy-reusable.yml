name: Reusable Full Stack Deploy
on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        required: true
        type: string
        description: "Target environment (dev/prod)"
      PROJECT_ID:
        required: true
        type: string
        description: "GCP Project ID"
      REGION:
        required: true
        type: string
        description: "GCP Region"
      VPC_CONNECTOR_NAME:
        required: true
        type: string
        description: "VPC Connector name"
      API_SERVICE_NAME:
        required: true
        type: string
        description: "Cloud Run API service name"
      DASHBOARD_SERVICE_NAME:
        required: true
        type: string
        description: "Cloud Run Dashboard service name"
      API_BASE_URL:
        required: true
        type: string
        description: "API base URL"
      DASHBOARD_CLIENT_URL:
        required: true
        type: string
        description: "Dashboard client URL for CORS"
      DB_HOST:
        required: true
        type: string
        description: "Database host IP address"
      DB_USER:
        required: true
        type: string
        description: "Database user name"
      DB_NAME:
        required: true
        type: string
        description: "Database name"
    secrets:
      db-password:
        required: true
      wif-provider:
        required: true
      service-account:
        required: true
      gcs-bucket-name:
        required: true
      cdn-url-map-name:
        required: true

jobs:
  # 統合ビルド・デプロイ: 全ての処理を一つのジョブで実行
  deploy-all:
    runs-on: ubuntu-latest
    environment: ${{ inputs.ENVIRONMENT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js for Change Detection
        uses: actions/setup-node@v4
        with:
          node-version: "22.10.0"

      - name: Install Dependencies for Change Detection
        run: |
          rm -rf node_modules package-lock.json
          npm install

      # 全アプリケーションを常にデプロイ（条件分岐なし）

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: apps/api/go.mod
          cache: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.wif-provider }}
          service_account: ${{ secrets.service-account }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ inputs.REGION }}-docker.pkg.dev

      - name: Build API Docker Image
        run: |
          echo "🔨 Building API Docker image (changes detected)..."
          cd apps/api
          docker build \
            --cache-from=${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:latest \
            --tag ${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:${{ github.sha }} \
            --tag ${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:latest \
            .

      - name: Push API Docker Image
        run: |
          echo "📦 Pushing API Docker image to registry..."
          docker push ${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:${{ github.sha }}
          docker push ${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:latest

      - name: Setup Node.js for Frontend Build
        uses: actions/setup-node@v4
        with:
          node-version: "22.10.0"

      - name: Install Frontend Dependencies
        run: |
          echo "📦 Installing dashboard dependencies (changes detected)..."
          # クリーンインストールで依存関係の問題を回避
          rm -rf node_modules package-lock.json
          npm install

      - name: Build Frontend
        env:
          VITE_API_BASE_URL: ${{ inputs.API_BASE_URL }}/api/v1
        run: |
          echo "🔨 Building dashboard (changes detected)..."
          npm run build --workspace=dashboard

      # Step 1: API No-Traffic Deploy（変更検知時のみ実行）
      - name: Deploy API (No Traffic)
        run: |
          echo "🚀 Deploying API service (no traffic)..."
          gcloud run deploy ${{ inputs.API_SERVICE_NAME }} \
            --image=${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:${{ github.sha }} \
            --region=${{ inputs.REGION }} \
            --no-traffic \
            --vpc-connector=${{ inputs.VPC_CONNECTOR_NAME }}

      # Step 2: Database Migration（常に実行）
      - name: Run Database Migration
        run: |
          echo "🚀 Running database migrations..."
          JOB_NAME="migration-job-$(date +%s)"

          gcloud run jobs create $JOB_NAME \
            --image=${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:${{ github.sha }} \
            --region=${{ inputs.REGION }} \
            --vpc-connector=${{ inputs.VPC_CONNECTOR_NAME }} \
            --set-env-vars="DB_HOST=${{ inputs.DB_HOST }},DB_USER=${{ inputs.DB_USER }},DB_NAME=${{ inputs.DB_NAME }}" \
            --set-secrets="DB_PASSWORD=api-db-password:latest" \
            --service-account=api-cloud-run-sa@${{ inputs.PROJECT_ID }}.iam.gserviceaccount.com \
            --command="sh" \
            --args="-c","export PGHOST=\$DB_HOST && export PGPORT=5432 && export PGUSER=\$DB_USER && export PGPASSWORD=\$DB_PASSWORD && export PGDATABASE=\$DB_NAME && export PGSSLMODE=require && migrate -path migrations -database postgres://\$PGUSER:\$PGPASSWORD@\$PGHOST:\$PGPORT/\$PGDATABASE?sslmode=\$PGSSLMODE up"

          gcloud run jobs execute $JOB_NAME --wait --region=${{ inputs.REGION }}
          echo "✅ Database migrations completed"

      # Step 3: API Traffic切り替え + ヘルスチェック（API変更時のみ実行）
      - name: Switch API Traffic
        run: |
          echo "🔄 Switching API traffic to new revision..."
          gcloud run services update-traffic ${{ inputs.API_SERVICE_NAME }} \
            --region=${{ inputs.REGION }} \
            --to-latest

      # Step 4: Frontend Deploy（Dashboard変更時のみ実行、apiが実行をされて成功をされたことを確認後にデプロイをする）
      - name: Deploy Frontend to Cloud Storage
        run: |
          echo "🚀 Deploying frontend to Cloud Storage..."
          # ビルドされたファイルをCloud Storageにアップロード
          gsutil -m rsync -r -d ./apps/dashboard/dist gs://${{ secrets.gcs-bucket-name }}
          gsutil -m setmeta -h "Cache-Control:public, max-age=3600" -r gs://${{ secrets.gcs-bucket-name }}/**
          echo "✅ Frontend deployed to Cloud Storage"

      - name: Invalidate CDN Cache
        run: |
          echo "🔄 Invalidating CDN cache..."
          gcloud compute url-maps invalidate-cdn-cache ${{ secrets.cdn-url-map-name }} \
            --path "/*" \
            --global
          echo "✅ CDN cache invalidated"

      # Step 5: 統合ヘルスチェック（変更されたサービスのみ）
      - name: Dashboard Health Check
        run: |
          echo "🔍 Checking Dashboard health..."
          curl -f "${{ inputs.DASHBOARD_CLIENT_URL }}"

      - name: Basic Integration Check
        run: |
          echo "🔍 Running basic integration check..."
          # Dashboard画面が正常に表示されることを確認
          if curl -s "${{ inputs.DASHBOARD_CLIENT_URL }}" | grep -q "<!doctype html>"; then
            echo "✅ Dashboard is serving content successfully"
          else
            echo "❌ Dashboard integration check failed"
            exit 1
          fi

      # ===== デプロイ完了レポート =====
      # Step 6: デプロイ結果サマリー生成（GitHub Actions Summary出力）
      - name: Deployment Complete
        run: |
          echo "### 🚀 Full Stack Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API:** ✅ Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ inputs.API_BASE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**API Image:** ${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard:** ✅ Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard URL:** ${{ inputs.DASHBOARD_CLIENT_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard:** Static files deployed to Cloud Storage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
