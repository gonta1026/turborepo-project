name: Reusable Full Stack Deploy
on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        required: true
        type: string
        description: "Target environment (dev)"
      PROJECT_ID:
        required: true
        type: string
        description: "GCP Project ID"
      REGION:
        required: true
        type: string
        description: "GCP Region"
      VPC_CONNECTOR_NAME:
        required: true
        type: string
        description: "VPC Connector name"
      API_SERVICE_NAME:
        required: true
        type: string
        description: "Cloud Run API service name"
      DASHBOARD_SERVICE_NAME:
        required: true
        type: string
        description: "Cloud Run Dashboard service name"
      API_BASE_URL:
        required: true
        type: string
        description: "API base URL"
      DASHBOARD_BASE_URL:
        required: true
        type: string
        description: "Dashboard base URL"
    secrets:
      db-password:
        required: true
      wif-provider:
        required: true
      service-account:
        required: true
      gcs-bucket-name:
        required: true
      cdn-url-map-name:
        required: true

jobs:
  # çµ±åˆãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤: å…¨ã¦ã®å‡¦ç†ã‚’ä¸€ã¤ã®ã‚¸ãƒ§ãƒ–ã§å®Ÿè¡Œ
  deploy-all:
    runs-on: ubuntu-latest
    environment: ${{ inputs.ENVIRONMENT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js for Change Detection
        uses: actions/setup-node@v4
        with:
          node-version: "22.10.0"

      - name: Install Dependencies for Change Detection
        run: |
          rm -rf node_modules package-lock.json
          npm install

      # Turborepoå¤‰æ›´æ¤œçŸ¥: å„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã‚’å€‹åˆ¥ã«æ¤œçŸ¥
      - name: Detect Changes with Turbo
        id: turbo-changes
        run: |
          echo "ğŸ” Checking for changes using Turborepo..."
          
          # APIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ãƒã‚§ãƒƒã‚¯
          if npx turbo run build --filter=api --dry-run=json | jq -r '.tasks[] | select(.package == "api") | .cache.status' | grep -q "MISS"; then
            echo "api-changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ API changes detected - will deploy"
          else
            echo "api-changed=false" >> $GITHUB_OUTPUT  
            echo "âœ… API unchanged - skipping deployment"
          fi
          
          # Dashboardã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ãƒã‚§ãƒƒã‚¯
          if npx turbo run build --filter=dashboard --dry-run=json | jq -r '.tasks[] | select(.package == "dashboard") | .cache.status' | grep -q "MISS"; then
            echo "dashboard-changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Dashboard changes detected - will deploy"
          else
            echo "dashboard-changed=false" >> $GITHUB_OUTPUT
            echo "âœ… Dashboard unchanged - skipping deployment"
          fi
          
          echo "ğŸ“‹ Turbo analysis:"
          npx turbo run build --filter=api,dashboard --dry-run=json | jq -r '.tasks[] | "\(.package): \(.cache.status)"'

      # Turborepoã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°: å¤‰æ›´ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
      - name: Update Turbo Cache for Changed Apps
        run: |
          echo "ğŸ”„ Updating Turborepo cache for changed applications..."
          
          if [ "${{ steps.turbo-changes.outputs.api-changed }}" == "true" ]; then
            echo "ğŸ“¦ Updating cache for API application..."
            turbo run build --filter=api
          fi
          
          if [ "${{ steps.turbo-changes.outputs.dashboard-changed }}" == "true" ]; then
            echo "ğŸ“¦ Updating cache for Dashboard application..."
            turbo run build --filter=dashboard
          fi
          
          echo "âœ… Turbo cache update completed"
        env:
          TURBO_API: https://turbo-cache-server-cvezib2f4q-an.a.run.app
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: my-team

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: apps/api/go.mod
          cache: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.wif-provider }}
          service_account: ${{ secrets.service-account }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ inputs.REGION }}-docker.pkg.dev

      - name: Build API Docker Image
        if: steps.turbo-changes.outputs.api-changed == 'true'
        run: |
          echo "ğŸ”¨ Building API Docker image (changes detected)..."
          cd apps/api
          docker build \
            --cache-from=${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:latest \
            --tag ${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:${{ github.sha }} \
            --tag ${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:latest \
            .

      - name: Push API Docker Image
        if: steps.turbo-changes.outputs.api-changed == 'true'
        run: |
          echo "ğŸ“¦ Pushing API Docker image to registry..."
          docker push ${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:${{ github.sha }}
          docker push ${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:latest

      - name: Setup Node.js for Frontend Build
        if: steps.turbo-changes.outputs.dashboard-changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "22.10.0"

      - name: Install Frontend Dependencies
        if: steps.turbo-changes.outputs.dashboard-changed == 'true'
        run: |
          echo "ğŸ“¦ Installing dashboard dependencies (changes detected)..."
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ä¾å­˜é–¢ä¿‚ã®å•é¡Œã‚’å›é¿
          rm -rf node_modules package-lock.json
          npm install

      - name: Build Frontend
        if: steps.turbo-changes.outputs.dashboard-changed == 'true'
        run: |
          echo "ğŸ”¨ Building dashboard (changes detected)..."
          npm run build --workspace=dashboard

      # Step 1: API No-Traffic Deployï¼ˆå¤‰æ›´æ¤œçŸ¥æ™‚ã®ã¿å®Ÿè¡Œï¼‰
      - name: Deploy API (No Traffic)
        if: steps.turbo-changes.outputs.api-changed == 'true'
        run: |
          echo "ğŸš€ Deploying API service (no traffic)..."
          gcloud run deploy ${{ inputs.API_SERVICE_NAME }} \
            --image=${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:${{ github.sha }} \
            --region=${{ inputs.REGION }} \
            --no-traffic \
            --vpc-connector=${{ inputs.VPC_CONNECTOR_NAME }} \
            --set-env-vars="DB_HOST=10.71.0.5,DB_USER=api_user,DB_NAME=api_db,DB_PORT=5432" \
            --set-secrets="DB_PASSWORD=api-db-password:latest" \
            --service-account=api-cloud-run-sa@${{ inputs.PROJECT_ID }}.iam.gserviceaccount.com

      # Step 2: Database Migration Checkï¼ˆAPIå¤‰æ›´æ™‚ã®ã¿å®Ÿè¡Œï¼‰
      - name: Check Migration Requirements
        if: steps.turbo-changes.outputs.api-changed == 'true'
        id: migration-check
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "apps/api/migrations/"; then
            echo "migration-required=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Database migration files detected"
          else
            echo "migration-required=false" >> $GITHUB_OUTPUT
            echo "âœ… No migration files changed"
          fi

      - name: Run Database Migration
        if: steps.turbo-changes.outputs.api-changed == 'true' && steps.migration-check.outputs.migration-required == 'true'
        run: |
          echo "ğŸš€ Running database migrations..."
          gcloud run jobs create migration-job-${{ github.sha }} \
            --image=${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:${{ github.sha }} \
            --region=${{ inputs.REGION }} \
            --vpc-connector=${{ inputs.VPC_CONNECTOR_NAME }} \
            --set-env-vars="DB_HOST=10.71.0.5,DB_USER=api_user,DB_NAME=api_db,DB_PORT=5432" \
            --set-secrets="DB_PASSWORD=api-db-password:latest" \
            --service-account=api-cloud-run-sa@${{ inputs.PROJECT_ID }}.iam.gserviceaccount.com \
            --command="make" \
            --args="migrate-up"
            
          gcloud run jobs execute migration-job-${{ github.sha }} --wait --region=${{ inputs.REGION }}
          echo "âœ… Database migrations completed"

      # Step 3: API Trafficåˆ‡ã‚Šæ›¿ãˆ + ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆAPIå¤‰æ›´æ™‚ã®ã¿å®Ÿè¡Œï¼‰
      - name: Switch API Traffic
        if: steps.turbo-changes.outputs.api-changed == 'true'
        run: |
          echo "ğŸ”„ Switching API traffic to new revision..."
          gcloud run services update-traffic ${{ inputs.API_SERVICE_NAME }} \
            --region=${{ inputs.REGION }} \
            --to-latest

      - name: API Health Check
        if: steps.turbo-changes.outputs.api-changed == 'true'
        run: |
          echo "ğŸ” Checking API health..."
          for i in {1..30}; do
            if curl -f "${{ inputs.API_BASE_URL }}/health"; then
              echo "âœ… API is healthy!"
              break
            fi
            echo "â³ Waiting for API to be ready... ($i/30)"
            sleep 10
          done

      # Step 4: Frontend Deployï¼ˆDashboardå¤‰æ›´æ™‚ã®ã¿å®Ÿè¡Œï¼‰
      - name: Deploy Frontend to Cloud Storage
        if: steps.turbo-changes.outputs.dashboard-changed == 'true'
        run: |
          echo "ğŸš€ Deploying frontend to Cloud Storage..."
          # ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’Cloud Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          gsutil -m rsync -r -d ./apps/dashboard/dist gs://${{ secrets.gcs-bucket-name }}
          gsutil -m setmeta -h "Cache-Control:public, max-age=3600" -r gs://${{ secrets.gcs-bucket-name }}/**
          echo "âœ… Frontend deployed to Cloud Storage"

      - name: Invalidate CDN Cache
        if: steps.turbo-changes.outputs.dashboard-changed == 'true'
        run: |
          echo "ğŸ”„ Invalidating CDN cache..."
          gcloud compute url-maps invalidate-cdn-cache ${{ secrets.cdn-url-map-name }} \
            --path "/*" \
            --global
          echo "âœ… CDN cache invalidated"

      # Step 5: çµ±åˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ï¼‰
      - name: Dashboard Health Check
        if: steps.turbo-changes.outputs.dashboard-changed == 'true'
        run: |
          echo "ğŸ” Checking Dashboard health..."
          curl -f "${{ inputs.DASHBOARD_BASE_URL }}"

      - name: Basic Integration Check
        if: steps.turbo-changes.outputs.dashboard-changed == 'true'
        run: |
          echo "ğŸ” Running basic integration check..."
          # Dashboardç”»é¢ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
          if curl -s "${{ inputs.DASHBOARD_BASE_URL }}" | grep -q "<!doctype html>"; then
            echo "âœ… Dashboard is serving content successfully"
          else
            echo "âŒ Dashboard integration check failed"
            exit 1
          fi

      # ===== ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ =====
      # Step 6: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚µãƒãƒªãƒ¼ç”Ÿæˆï¼ˆGitHub Actions Summaryå‡ºåŠ›ï¼‰
      - name: Deployment Complete
        run: |
          echo "### ğŸš€ Selective Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å¤‰æ›´æ¤œçŸ¥çµæœã‚’ã‚µãƒãƒªãƒ¼ã«è¿½åŠ 
          if [ "${{ steps.turbo-changes.outputs.api-changed }}" == "true" ]; then
            echo "**API:** âœ… Changes detected - Deployed" >> $GITHUB_STEP_SUMMARY
            echo "**API URL:** ${{ inputs.API_BASE_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "**API Image:** ${{ inputs.REGION }}-docker.pkg.dev/${{ inputs.PROJECT_ID }}/api-service/api:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**API:** â­ï¸ No changes detected - Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.turbo-changes.outputs.dashboard-changed }}" == "true" ]; then
            echo "**Dashboard:** âœ… Changes detected - Deployed" >> $GITHUB_STEP_SUMMARY
            echo "**Dashboard URL:** ${{ inputs.DASHBOARD_BASE_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "**Dashboard:** Static files deployed to Cloud Storage" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Dashboard:** â­ï¸ No changes detected - Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
