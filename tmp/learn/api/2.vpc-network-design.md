# VPCネットワーク設計書

## 設計概要

既存のTurboRepo構成を拡張して、API用のVPCネットワーク基盤を構築します。

### 現在の構成

```
apps/terraform/gcp/environments/dev/
├── shared/      # IAM設定のみ
├── dashboard/   # Cloud Storage + CDN + Certificate Manager（完全構成）
└── backend/     # Terraform状態管理
```

### 拡張後の構成

```
apps/terraform/gcp/environments/dev/
├── shared/      # 共通リソース（VPC + Certificate Manager統合）
├── dashboard/   # 既存のまま（変更なし）
├── api/         # 新規作成（Cloud Run + Cloud SQL）
└── backend/     # 既存のまま
```

## VPCアーキテクチャ設計

### ネットワーク構成

```
┌─────────────────────────────────────────────────────────┐
│                    main-vpc                             │
│                                                         │
├─────────────────────┬───────────────────────────────────┤
│ public-subnet       │ private-subnet                    │
│ 10.0.1.0/24         │ 10.0.2.0/24                      │
│                     │                                   │
│ - Load Balancer     │ - Cloud SQL (プライベート)        │
│ - NAT Gateway       │ - VPC Connector                   │
└─────────────────────┴───────────────────────────────────┘
│
├── Cloud NAT (プライベートサブネット用のインターネット接続)
├── Private Google Access (GCP APIアクセス用)
└── VPC Connector (Cloud Run → VPC統合用)
```

### IPアドレス設計

- **VPC CIDR**: `10.0.0.0/16`
- **Public Subnet**: `10.0.1.0/24` (254 IP)
- **Private Subnet**: `10.0.2.0/24` (254 IP)
- **Private Service Connection**: `10.0.100.0/24` (Cloud SQL用)

## Certificate Manager統合設計

### ドメイン構成

```
my-learn-iac-sample.site (既存・dashboard用)
├── 静的IP: dashboard-ip
└── Certificate: dashboard-cert

dev.api.my-learn-iac-sample.site (新規・API用)
├── 静的IP: api-ip (新規取得)
└── Certificate: api-cert (新規作成)
```

### Certificate Manager構成

```
Certificate Map: shared-cert-map (統合管理)
├── dashboard用エントリー (既存)
│   ├── hostname: my-learn-iac-sample.site
│   └── certificate: dashboard-cert
└── API用エントリー (新規追加)
    ├── hostname: dev.api.my-learn-iac-sample.site
    └── certificate: api-cert
```

## セキュリティ設計

### ファイアウォールルール

```yaml
# デフォルト拒否
default-deny-all:
  direction: INGRESS
  action: DENY
  priority: 65534

# HTTPS許可（Load Balancer用）
allow-https-lb:
  ports: [443, 80]
  sources: [0.0.0.0/0]
  targets: [https-server]

# Cloud SQL接続許可
allow-cloud-sql:
  sources: [VPC Connector]
  targets: [private-subnet]
  ports: [5432]
```

### プライベート接続

- **Cloud SQL**: プライベートIPのみ、パブリックIP無効
- **VPC Connector**: Cloud Run → VPC統合
- **Private Google Access**: GCP API接続用

## DNS・SSL戦略

### 段階的設定フロー

```
Phase 1: 静的IP取得
├── terraform apply → 静的IP作成
├── terraform output → IP確認
└── DNS設定準備

Phase 2: DNS設定（手動）
├── dev.api.my-learn-iac-sample.site → 静的IP
├── DNS伝播確認 (24-48時間)
└── nslookup/dig での検証

Phase 3: Certificate Manager
├── DNS設定後の証明書自動取得
├── Certificate Map Entry追加
└── SSL証明書状態確認

Phase 4: API リソース
├── Cloud Run デプロイ
├── カスタムドメイン設定
└── HTTPS アクセス確認
```

## ファイル構成設計

### shared ディレクトリ追加

```
shared/
├── main.tf (既存)
├── iam.tf (既存)
├── variables.tf (既存)
├── terraform.tfvars (既存)
├── network.tf (新規) - VPC・サブネット・NAT
├── certificate.tf (新規) - Certificate Manager統合
├── outputs.tf (新規) - api が参照する値
└── backend.tf (新規) - remote state設定
```

### api ディレクトリ新規作成

```
api/
├── main.tf - プロバイダ・API有効化
├── cloud-sql.tf - PostgreSQL設定
├── cloud-run.tf - APIサーバー設定
├── variables.tf - 変数定義
├── terraform.tfvars - 変数値
├── outputs.tf - 外部出力
└── backend.tf - remote state設定
```

## 依存関係設計

```
shared (VPC・Certificate Manager)
├── network.tf → VPC、サブネット作成
├── certificate.tf → 静的IP、Certificate Manager
└── outputs.tf → api が参照

api (Cloud Run・Cloud SQL)
├── terraform_remote_state → shared 参照
├── cloud-sql.tf → VPC・プライベートサブネット使用
└── cloud-run.tf → VPC Connector・Certificate Map使用
```
